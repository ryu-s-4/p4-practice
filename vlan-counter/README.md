
# 概要と参考記事

簡易 L2 スイッチに VLAN 毎のトラヒックカウンタを実装し，コントロールプレーンからカウンタ値を取得します．
  
[p4-guide](https://github.com/jafingerhut/p4-guide)等を参照し，P4 開発環境が構築済みであることを前提とします．
動作確認手順は大きく下記の流れとなります．

1. P4 プログラムのコンパイル
2. 動作確認環境の構築
3. スイッチエミュレータ（BMv2）起動
4. テーブルエントリー設定
5. C/P プログラム実行（カウンタ値取得）

なお，P4 プログラムおよび C/P プログラムの中身については下記参考記事を参照ください．

- 参考記事１
  - [P4 で記述した簡易 L2 Switch にタグ VLAN（802.1Q）を対応させて VLAN 毎のトラヒックカウンタを実装する（準備編）](https://qiita.com/13ryuse4/items/cb83abd80712616e0799)
- 参考記事２
  - [P4 で記述した簡易 L2 Switch にタグ VLAN（802.1Q）を対応させて VLAN 毎のトラヒックカウンタを実装する（実装編）](https://qiita.com/13ryuse4/items/6f95ada4d248372603c2) 
- 参考記事３
  - [P4Runtime を用いて P4 で記述した簡易 L2 Switch のテーブルエントリ登録とトラヒックカウンタ値取得を行う（準備編）](https://qiita.com/13ryuse4/items/96ed8b31382e1fdd79f1)
- 参考記事４（執筆中）
  - [P4Runtime を用いて P4 で記述した簡易 L2 Switch のテーブルエントリ登録とトラヒックカウンタ値取得を行う（実装編）]()

# 動作確認

本 repository を clone した後，下記のように P4 プログラムをコンパイルします．

```
> cd p4-practice/vlan-counter
> p4c --std p4_16 -b bmv2 --p4runtime-files p4info.txt switching.p4
```

カレントディレクトリに ```p4info.txt``` と ```switching.json``` が生成されていることを確認してください．

続いて，動作環境用の環境を構築します．今回は下記のような構成とします．

```
Def. VLAN : 192.168.0.0/24
VLAN 100  : 192.168.100.0/24
  -> host1, host5
VLAN 200  : 192.168.200.0/24
  -> host1, host3, host7

                    -----
                   |host3|
                    -----
                    .3|
                      |
 -----  .1     ----------------      .5 -----
|host1| ----- |BMv2 (P4 Switch)| ----- |host5|
 -----         ----------------         -----
                      |
                    .7|
                    -----
                   |host7|
                    -----
```

